<%
--[[
    Info    路由器Wi-Fi设置
]]--
local ver = require("xiaoqiang.XQVersion").webVersion
local WifiUtil = require("xiaoqiang.util.XQWifiUtil")
local LuciJson = require("luci.json")
local XQFunction = require("xiaoqiang.common.XQFunction")
local XQSysUtil = require("xiaoqiang.util.XQSysUtil")

local remote_addr = luci.http.getenv("REMOTE_ADDR") or ""
local mac = luci.sys.net.ip4mac(remote_addr) or ""

local channel1 = WifiUtil.getDefaultWifiChannels(1)
local channel2 = WifiUtil.getDefaultWifiChannels(2)
local channel3 = WifiUtil.getDefaultWifiChannels(3)
local wifi_pddk = LuciJson.encode(channel1)
local wifi5_pddk = LuciJson.encode(channel2)
local wifi5_2_pddk = LuciJson.encode(channel3)

local active_apcli = XQFunction.get_active_apcli()
local romChannel = XQSysUtil.getChannel()
local uci = require("luci.model.uci").cursor()
local features = require("xiaoqiang.XQFeatures").FEATURES
local hardware = string.lower( XQSysUtil.getHardware() )
local netmod = 0
local netmod = XQFunction.getnetmode()
--4 mesh主设备  whc_cap
--3 mesh从设备  whc_re
--0 router
local wifiInfo = WifiUtil.getAllWifiInfo()
wifiInfo = LuciJson.encode(wifiInfo)
local wifi_count = WifiUtil.get_wlan_count()
local wifi_game = WifiUtil.get_wifi_game()
local wifimergeSupport = XQFunction.getFeature('0', 'wifi', 'wifimerge')
local mloSupport = XQFunction.getFeature('0', 'wifi', 'mlo')
local twtSupport = XQFunction.getFeature('0', 'wifi', 'twt')
local wifi50Support = XQFunction.getFeature('0', 'wifi', 'wifi50')
local mumimoSupport = XQFunction.getFeature('0', 'wifi', 'wifi_mu_mimo')
local wifi5Support = XQFunction.getFeature('0', 'wifi', 'wifi5_only')
local split5gSupport = XQFunction.getFeature('0', 'wifi', 'split5g')
local wifi_5g_split_status = 0
if split5gSupport == "1" then
    wifi_5g_split_status = tonumber(WifiUtil.get_wifi_split_status() or "0")
end
local active_apcli_index = WifiUtil.get_active_apcli_index()
%>
<%include("web/inc/head")%>
<title><%:小米路由器%></title>
<meta name="viewport" content="width=1200">
<link href="<%=resource%>/web/css/bc.css?v=<%=ver%>" rel="stylesheet">
<link href="<%=resource%>/web/css/wifi.css?v=<%=ver%>" rel="stylesheet">
</head>
<body>
<div id="doc">
    <%include("web/inc/header")%>
    <div id="bd">
    <%if wifimergeSupport == "1" and hardware ~= "r1cl" then%>
        <div class="mod-set mod-wifi">
            <div class="hd">
                <h3 class="wifiTit"><%if wifi_count == 2 then%><%:Wi-Fi双频合一%><%else%><%:Wi-Fi多频合一%><%end%></h3>
                <div class="switch">
                    <a href="#" id="bsdswitch" class="btn-switch btn-switch-off" data-on="0"></a>
                </div>
            </div>
            <div class="bd">
                <%if wifi_count == 2 then%>
                <p><%:开启后，2.4GHz和5GHz将合并显示为同一个名称，路由器将优先为终端选择最佳Wi-Fi网络。合并名称后部分终端可能离线，需重新连接。%></p>
                <%elseif wifi_count == 3 then%>
                    <%if wifi_game == 1  then%>
                    <p><%:开启后，2.4GHz、5GHz和5GHz-Game将合并显示为同一个名称，路由器将优先为终端选择最佳Wi-Fi网络。合并名称后部分终端可能离线，需重新连接。%></p>
                    <%else%>
                    <p><%:开启后，2.4GHz、5GHz和5GHz-2将合并显示为同一个名称，路由器将优先为终端选择最佳Wi-Fi网络。合并名称后部分终端可能离线，需重新连接。%></p>
                    <%end%>
                <%end%>
            </div>
        </div>
    <%end%>

<%if split5gSupport == "1" then%>
    <div class="mod-set mod-wifi">
        <div class="hd">
            <h3 class="wifiTit"><%:Wi-Fi模式切换%></h3>
        </div>
        <div class="bd">
            <p><%:双频模式：具有更好的覆盖能力，适合大部分的应用场景。%></p>
            <p><%:三频模式：覆盖弱于双频。可支持WiFi7手机双5G MLO并联，大幅提升带宽。同时可作为独立电竞频段，减少其他设备干扰。%></p>
            <div class="form-item-select modeSelect" style="margin-top: 15px;">
                <label class="k"><%:工作模式%></label>
                <span class="v">
                    <select name="wifiModeSelect" class="beautify" id="modeSelect">
                        <option value="0" <%if (wifi_5g_split_status == 0) then%>selected="selected"<%end%>><%:双频模式%></option>
                        <option value="1" <%if (wifi_5g_split_status == 1) then%>selected="selected"<%end%>><%:三频模式%></option>
                    </select>
                </span>
            </div>
            <div class="form-contral">
                <button id="btnSetWifiMode" class="btn btn-primary btn-l"><span><%:保存%></span></button>
            </div>
        </div>
    </div>
<%end%>

    <%if (wifi_count > 2) and (mloSupport == '1') then%>
        <div class="mod-set mod-wifi mod-mlo">
            <div class="hd">
                <h3><%:MLO设置%></h3>
                <div class="switch">
                    <a href="#" id="mloswitch" class="btn-switch btn-switch-off" data-on="0"></a>
                </div>
            </div>
            <div class="bd">
                <p><%:多频合一情况下，此路由器会默认开启MLO多链路连接，由Wi-Fi7终端自主选择并发频段接入，提高速率降低延迟。%></p>
                <div class="tips" style="display: none;">
                    <p><%:注：检测到已开启Wi-Fi5兼容模式，无法打开MLO开关。%></p>
                </div>
            </div>
        </div>
    <%end%>
        <div class="mod-set mod-wifi mod-wifi24">
            <div class="hd">
                <h3><%:Wi-Fi设置%></h3>
            </div>
            <div class="bd">
                <form class="form form-horizontal" id="wifiset24" name="wifiset24"  action="<%=luci.dispatcher.build_url("api", "xqnetwork", "set_wifi")%>" autocomplete="off">
                </form>
            </div>
        </div>
        <%if wifi50Support == "1" then%>
        <div class="mod-set mod-wifi mod-wifi50">
            <div class="bd">
                <form class="form form-horizontal" id="wifiset50" name="wifiset50" action="<%=luci.dispatcher.build_url("api", "xqnetwork", "set_wifi")%>" autocomplete="off">
                </form>
            </div>
        </div>
        <%end%>
        <%if wifi50Support == "1" then%>
        <div class="mod-set mod-wifi mod-wifi5g-2">
            <div class="bd">
                <form class="form form-horizontal" id="wifiset5g2" name="wifiset5g2" action="<%=luci.dispatcher.build_url("api", "xqnetwork", "set_wifi")%>" autocomplete="off">
                </form>
            </div>
        </div>
        <%end%>
        <%if wifi5Support ~= '1' then%>
         <div class="mod-set mod-wifi">
            <div class="hd">
                <h3><%:Wi-Fi 5(802.11ac)兼容模式%></h3>
                <div class="switch">
                    <a href="#WIFI6switch" id="WIFI6switch" class="btn-switch btn-switch-on" data-on="1"></a>
                </div>
            </div>
            <div class="bd">
                <p><%:某些老设备对Wi-Fi6协议支持不好，可能扫描不到信号或者连接不上等。开启此开关后，将会切换到Wi-Fi5模式，解决兼容问题。但同时会关闭Wi-Fi6的相关功能，如OFDMA、TWT、BSS Coloring等。
                %></p>
            </div>
        </div>
        <%end%>

        <%if twtSupport == '1' then%>
        <div class="mod-set mod-wifi mod-twt">
            <div class="hd">
                <div class="help">
                    <span class="ico"></span>
                    <span class="arrow-wrap" id="helpArrow">
                        <span class="arrow1"></span>
                        <span class="arrow2"></span>
                    </span>
                </div>
                <h3><%:TWT节能模式%></h3>
                <div class="switch">
                    <a href="#" id="twtswitch" class="btn-switch btn-switch-off" data-on="0"></a>
                </div>
            </div>
            <div class="bd">
                <div class="section section-help" id="helpSection">
                    <div class="help-cont">
                        <span class="help-close"></span>
                        <div class="what">
                            <h3><%:TWT节能模式兼容性问题解决办法%></h3>
                        </div>
                        <div class="qa">
                            <p><%:如果出现老旧终端在此路由开启TWT节能模式后出现兼容性问题，建议尝试以下方法：%></p>
                            <p><%:1. 到相应终端制造商官网下载更新驱动；%></p>
                            <p><%:2. 若最新驱动仍无法解决兼容性问题，建议先关闭该功能。%></p>
                        </div>
                    </div>
                </div>
                <div>
                    <p><%:开启TWT节能模式后，可通过TWT节能技术降低接入此路由器的Wi-Fi6终端设备功耗，部分老旧终端可能会有兼容性问题。%></p>
                    <div class="tips" style="display: none;">
                        <!-- <p><%:注：检测到已开启Wi-Fi5兼容模式，无法打开TWT开关。%></p> -->
                    </div>
                </div>
            </div>
        </div>
        <%end%>

        <%if mumimoSupport == "1" then%>
        <div class="mod-set mod-wifi">
            <div class="hd">
                <h3><%:MU-MIMO%></h3>
                <div class="switch">
                    <a href="#txbfswitch" id="txbfswitch" class="btn-switch btn-switch-on" data-on="1"></a>
                </div>
            </div>
            <div class="bd">
                <p><%:MU-MIMO“多用户多入多出”技术，可以让路由器与多台终端同时通信，极大改善无线资源利用效率，提升Wi-Fi体验。该功能生效需要路由器和终端同时支持。
                %></p>
            </div>
        </div>
        <%end%>

        <%if netmod ~= 3 then%>
        <div class="mod-set mod-wifi">
            <div class="hd">
                <h3><%:改密同步%></h3>
                <div class="switch">
                    <a href="#cklswitch" id="cklswitch" class="btn-switch btn-switch-on" data-on="1"></a>
                </div>
            </div>
            <div class="bd">
                <p><%:修改Wi-Fi名称或密码后，支持此功能的小米IoT设备可自动重连到路由器网络%></p>
            </div>
        </div>
        <%end%>

    </div>
    <%include("web/inc/footer")%>

</div>
<%include("web/inc/g.js")%>
<script type="text/tmpl" id="tplbsdWrap">
    <form class="form form-horizontal" id="wifisetbsd">
        <div id="wifisetbsdtop">
        </div>
        <p class="bsd-ground"><%:2.4G 选项%></p>
        <div id="wifiset24" class="form">
        </div>
        <p class="bsd-ground"><span class="wifi5gTit"><%:5G 选项%></span></p>
        <div id="wifiset50" class="form">
        </div>
<%if wifi_count > 2 then%>
        <div class="on35g2">
            <p class="bsd-ground"><%:5GHz-Game 选项%></p>
            <div id="wifiset5g2" class="form"></div>
        </div>
<%end%>
    </form>
</script>
<script type="text/tmpl" id="tplWifiBsdTop">
    <div class="item">
        <span class="k"><%:开关%></span>
        <span class="v">
            <%:中继模式下不允许关闭%>
        </span>
    </div>
    <div class="form-item">
        <label class="k"><%:名称%></label>
        <span class="v"><input type="text" name="ssid" value="{$ssid}" class="ipt-text" autocomplete="off" datatype="ssid" maxLength="{$ssidLenMax}" minLength="1" reqMsg="<%:Wi-Fi名称%>" /></span>
        <em class="t"></em>
    </div>
    <div class="form-item">
        <label for="hidessid{$wifitype}"> <input type="checkbox" id="hidessid{$wifitype}" name="hidden" value="1" {if ($hidden == 1)}checked{/if}> <span><%:隐藏网络不被发现%></span></label>
    </div>
    <div class="form-item-select">
        <label class="k"><%:加密方式%></label>
        <span class="v">
            <select name="encryption" class="beautify encryption" >

                <option value="ccmp"{if ($encryption == "ccmp")} selected{/if}><%:超强加密(WPA3个人版)%></option>
                <option value="psk2+ccmp"{if ($encryption == "psk2+ccmp")} selected{/if}><%:强混合加密(WPA3/WPA2个人版)%></option>

                <option value="psk2"{if ($encryption == "psk2")} selected{/if}><%:强加密(WPA2个人版)%></option>
                <option value="mixed-psk"{if ($encryption == "mixed-psk")} selected{/if}><%:混合加密(WPA/WPA2个人版)%></option>
                <option value="none"{if ($encryption == "none")} selected{/if}><%:无加密(允许所有人连接)%></option>
            </select>
        </span>
        <em class="t0" style="display: inline;">
            {if ($encryption == "ccmp")} <%:WPA3为新一代加密技术，可使安全性大大加强，但选择该选项后部分旧设备会存在兼容性问题而无法接入%>
            {/if}
            {if ($encryption == "psk2+ccmp")} <%:WPA3为新一代加密技术，可使安全性大大加强，但选择该选项后部分旧设备会存在兼容性问题而无法接入%>
            {/if}
            {if ($encryption == "none")} <%:当前加密方法不安全。建议选择混合加密（WPA/WPA2-personal）或其他更安全的加密方法。%>
            {/if}
        </em>
    </div>
    <div class="form-item form-item-encryption" {if($encryption != "none" && $encryption != "mixed-psk")} style="margin-bottom:0px"{/if} style="color: #D92719">{if($encryption == "none" || $encryption == "mixed-psk")}<%:非安全加密，建议切换为强加密（WPA2）%>{/if}</div>
    <div class="form-item" {if($encryption == "none")} style="display:none;"{/if}>
        <label class="k"><%:密码%></label>
        <span class="v">
            <input type="password" data-type="password" name="pwd" value="{$password}" class="ipt-text" autocomplete="off" datatype="wifipassword" minLength="8" maxLength="63" reqMsg="<%:Wi-Fi密码%>" />
        </span>
        <em class="t"></em>
    </div>
</script>
<script type="text/tmpl" id="tplWifiBsd">
   {if ($relayWifi == 0)}
        <input type="hidden" name="channel" value="{$channel}">
        <input type="hidden" name="bandwidth" value="{$bandwidth}">
        <input type="hidden" name="txpwr" value="{$txpwr}">
        <div class="form-item-select">
        <label class="k"><%:信号强度%></label>
        <span class="v">
            <select name="txpwr" class="beautify txpwr">
                <option value="max"{if ($txpwr == "max")} selected{/if}><%:穿墙%></option>
                <option value="mid"{if ($txpwr == "mid")} selected{/if}><%:标准%></option>
                <option value="min"{if ($txpwr == "min")} selected{/if}><%:节能%></option>
            </select>
        </span>
        <em class="t"></em>
    </div>
    {else}
    <div class="form-item-select">
        <label class="k"><%:无线信道%></label>
        <span class="v">
        <select name="channel" class="beautify channel"  data-id="{$wifitype}">
            {for(var i=0, len=$channels.length; i<len; i++)}
                <option value="{$channels[i]['c']}" {if ($channel==$channels[i]['c'])}selected{/if}>
                {if ($channels[i]['c']==0)}<%:自动%>
                    {if ($channelInfo["channel"] != "0")}
                        ({$channelInfo["channel"]})
                    {/if}
                {else}
                    {$channels[i]['c']}
                {/if}
                </option>
            {/for}
        </select>
        </span>
        <em class="t"></em>
    </div>
    <div class="form-item-select itemBandwidth">
        <label class="k"><%:频段带宽%></label>
        <span class="v">
            <select name="bandwidth" class="beautify" >
                {if ($channelInfo["bandList"].length > 3)}
                    <option value="0" {if ($bandwidth  == "0" )}selected="selected"{/if}><%:160/80/40/20MHz%></option>
                {/if}
                {if ($channelInfo["bandList"].length == 3)}
                    <option value="0" {if ($bandwidth  == "0" )}selected="selected"{/if}><%:80/40/20MHz%></option>
                {/if}
                {if ($channelInfo["bandList"].length == 2)}
                    <option value="0" {if ($bandwidth  == "0" )}selected="selected"{/if}><%:40/20MHz%></option>
                {/if}
                {for(var i=0, len=$channelInfo["bandList"].length; i<len && i<3; i++)}
                    <option value="{$channelInfo["bandList"][i]}" {if ($channelInfo["bandList"][i] == $bandwidth)}selected="selected"{/if}>{$channelInfo["bandList"][i]}M</option>
                {/for}
            </select>
            
        </span>
        <em class="t"></em>
    </div>
    <div class="form-item-select">
        <label class="k"><%:信号强度%></label>
        <span class="v">

            <select name="txpwr" class="beautify txpwr" >
                <option value="max"{if ($txpwr == "max")} selected{/if}><%:穿墙%></option>
                <option value="mid"{if ($txpwr == "mid")} selected{/if}><%:标准%></option>
                <option value="min"{if ($txpwr == "min")} selected{/if}><%:节能%></option>
            </select>
        </span>
        <em class="t"></em>
    </div>
    {/if}
    {if ($wifiIndex == 3 && $on3 == 1 || $wifiIndex == 2 && $on3 == 0)}
    <div class="form-contral">
        <button type="submit" class="btn btn-primary btn-l hidden"><span><%:保存%></span></button>
    </div>
    {/if}
</script>
<script type="text/tmpl" id="tplWifi">
    <input type="hidden" value="{$wifiIndex}" name="wifiIndex">
    <div class="item">
        <span class="k"><%:开关%></span>
        <span class="v">
        {if ($relayWifi == 0)}
            <%:中继模式下不允许关闭%>
        {else}
            <label><input type="radio" name="on" value="1"{if ($status == 1)} checked{/if}> <span><%:开启%></span></label>
            <label><input type="radio" name="on" value="0"{if ($status == 0)} checked{/if}> <span><%:关闭%></span></label>
        {/if}
        </span>
    </div>
    <div class="form-item">
        <label class="k"><%:名称%></label>
        <span class="v"><input type="text" name="ssid" value="{$ssid}" class="ipt-text" autocomplete="off" datatype="ssid" maxLength="{$ssidLenMax}" minLength="1" reqMsg="<%:Wi-Fi名称%>" /></span>
        <em class="t"></em>
    </div>
    <div class="form-item">
        <label for="hidessid{$wifitype}"> <input type="checkbox" id="hidessid{$wifitype}" name="hidden" value="1" {if ($hidden == 1)}checked{/if}> <span><%:隐藏网络不被发现%></span></label>
    </div>
    <div class="form-item-select">
        <label class="k"><%:加密方式%></label>
        <span class="v">
            <select name="encryption" class="beautify encryption" >
                <option value="ccmp"{if ($encryption == "ccmp")} selected{/if}><%:超强加密(WPA3个人版)%></option>
                <option value="psk2+ccmp"{if ($encryption == "psk2+ccmp")} selected{/if}><%:强混合加密(WPA3/WPA2个人版)%></option>


                <option value="psk2"{if ($encryption == "psk2")} selected{/if}><%:强加密(WPA2个人版)%></option>
                <option value="mixed-psk"{if ($encryption == "mixed-psk")} selected{/if}><%:混合加密(WPA/WPA2个人版)%></option>
                <option value="none"{if ($encryption == "none")} selected{/if}><%:无加密(允许所有人连接)%></option>
            </select>
        </span>
        <em class="t0" style="display: inline;">
            {if ($encryption == "ccmp")} <%:WPA3为新一代加密技术，可使安全性大大加强，但选择该选项后部分旧设备会存在兼容性问题而无法接入%>
            {/if}
            {if ($encryption == "psk2+ccmp")} <%:WPA3为新一代加密技术，可使安全性大大加强，但选择该选项后部分旧设备会存在兼容性问题而无法接入%>
            {/if}
            {if ($encryption == "none")} <%:当前加密方法不安全。建议选择混合加密（WPA/WPA2-personal）或其他更安全的加密方法。%>
            {/if}
        </em>
    </div>
    <div class="form-item form-item-encryption" {if($encryption != "none" && $encryption != "mixed-psk")} style="margin-bottom:0px"{/if} style="color: #D92719">{if($encryption == "none" || $encryption == "mixed-psk")}<%:非安全加密，建议切换为强加密（WPA2）%>{/if}</div>
    <div class="form-item" {if($encryption == "none")} style="display:none;"{/if}>
        <label class="k"><%:密码%></label>
        <span class="v">
            <input type="password" data-type="password" name="pwd" value="{$password}" class="ipt-text" autocomplete="off" datatype="wifipassword" minLength="8" maxLength="63" reqMsg="<%:Wi-Fi密码%>" />
        </span>
        <em class="t"></em>
    </div>
    {if ($relayWifi == 0)}
        <input type="hidden" name="channel" value="{$channel}">
        <input type="hidden" name="bandwidth" value="{$bandwidth}">
        <input type="hidden" name="txpwr" value="{$txpwr}">
        <div class="form-item-select">
            <label class="k"><%:信号强度%></label>
            <span class="v">

                <select name="txpwr" class="beautify txpwr" >
                    <option value="max"{if ($txpwr == "max")} selected{/if}><%:穿墙%></option>
                    <option value="mid"{if ($txpwr == "mid")} selected{/if}><%:标准%></option>
                    <option value="min"{if ($txpwr == "min")} selected{/if}><%:节能%></option>
                </select>
            </span>
            <em class="t"></em>
        </div>
    {else}
    <div class="form-item-select itemChannel">
        <label class="k"><%:无线信道%></label>
        <span class="v">
        <select name="channel" class="beautify channel"  data-id="{$wifitype}">
            {for(var i=0, len=$channels.length; i<len; i++)}
                <option value="{$channels[i]['c']}" {if ($channel==$channels[i]['c'])}selected{/if}>
                {if ($channels[i]['c']==0)}<%:自动%>
                    {if ($channelInfo["channel"] != "0")}
                        ({$channelInfo["channel"]})
                    {/if}
                {else}
                    {$channels[i]['c']}
                {/if}
                </option>
            {/for}
        </select>
        </span>
        <em class="t"></em>
    </div>
    <div class="form-item-select itemBandwidth" >
        <label class="k"><%:频段带宽%></label>
        <span class="v">
            <select name="bandwidth" class="beautify bandwidth" id="bandwidth" >
                {if ($channelInfo["bandList"].length > 3)}
                    <option value="0" {if ($bandwidth  == "0" )}selected="selected"{/if}><%:160/80/40/20MHz%></option>
                {/if}
                {if ($channelInfo["bandList"].length == 3)}
                    <option value="0" {if ($bandwidth  == "0" )}selected="selected"{/if}><%:80/40/20MHz%></option>
                {/if}
                {if ($channelInfo["bandList"].length == 2)}
                    <option value="0" {if ($bandwidth  == "0" )}selected="selected"{/if}><%:40/20MHz%></option>
                {/if}
                {for(var i=0, len=$channelInfo["bandList"].length; i<len && i<3; i++)}
                    <option value="{$channelInfo["bandList"][i]}" {if ($channelInfo["bandList"][i] == $bandwidth)}selected="selected"{/if}>{$channelInfo["bandList"][i]}MHz</option>
                {/for}
            </select>
        </span>
        <em class="t"></em>
    </div>
    <div class="form-item-select">
        <label class="k"><%:信号强度%></label>
        <span class="v">

            <select name="txpwr" class="beautify txpwr" >
                <option value="max"{if ($txpwr == "max")} selected{/if}><%:穿墙%></option>
                <option value="mid"{if ($txpwr == "mid")} selected{/if}><%:标准%></option>
                <option value="min"{if ($txpwr == "min")} selected{/if}><%:节能%></option>
            </select>
        </span>
        <em class="t"></em>
    </div>
    {/if}
    {if ($wifiIndex == 3 && $on3 == 1 || $wifiIndex == 2 && $on3 == 0)}
    <div class="form-contral">
        <button type="submit" class="btn btn-primary btn-l hidden"><span><%:保存%></span></button>
    </div>
    {/if}
</script>
<script>
var netmod = <%=netmod%>;
var wificount = <%=wifi_count%>;
(function(){
    var global = {};
    var generateMixed = function (n) {
         var res = "";
         var chars = ['0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];
         for(var i = 0; i < n ; i ++) {
             var id = Math.ceil(Math.random()*35);
             res += chars[id];
         }
         return res;
    }
    function onControlFocus() {
        $(this).parents('form').find('.btn-primary').removeClass('hidden');
        if($(this).parents('form').attr('id') == 'wifiset24'){
            $('.mod-wifi50').find('#wifiset50').find('.btn-primary').removeClass('hidden');
        }
        $('.mod-wifi5g-2').find('#wifiset5g2').find('.btn-primary').removeClass('hidden');
    }

    if ((wificount > 2) && ('<%=mloSupport%>' == '1')) {
        function getMLOCfg() {
            var isClosed = false;
            if ($("#WIFI6switch").attr("data-on") == 1) {
                isClosed = true;
                $(".mod-mlo").find(".tips").show().find("p").html("<%:注：检测到已开启Wi-Fi5兼容模式，无法打开MLO开关。%>");
            }
            else if ($("#bsdswitch").attr("data-on") == 0) {
                isClosed = true;
                $(".mod-mlo").find(".tips").show().find("p").html("<%:注：检测到未开启Wi-Fi多频合一，无法打开MLO开关。%>");
            }
            if (isClosed) {
                $("#mloswitch").removeClass("btn-switch-on")
                .addClass("btn-switch-off")
                .attr("data-on", "0");
                return;
            }
            $(".mod-mlo").find(".tips").hide();
            $.ajax({
                url: '<%=luci.dispatcher.build_url("api", "xqnetwork", "get_hostap_mlo")%>',
                type: 'GET',
                datatype: 'json',
                async: true,
                success: function( rsp ){
                    rsp = $.parseJSON(rsp);
                    if (rsp.code === 0) {
                        if (rsp.mlo_enable == 1) {
                            $("#mloswitch").removeClass("btn-switch-off")
                            .addClass("btn-switch-on")
                            .attr("data-on", "1");
                        }
                        else {
                            $("#mloswitch").removeClass("btn-switch-on")
                            .addClass("btn-switch-off")
                            .attr("data-on", "0");
                        }
                    }
                }
            });
        }
        $.sub( 'wifi:mlo', function(){
            function setMLOCfg() {
                var mlo_enable = $("#mloswitch").attr("data-on") == "0" ? 1 : 0,
                    requestData = {mlo_enable};

                $.ajax({
                    url: '<%=luci.dispatcher.build_url("api", "xqnetwork", "set_hostap_mlo")%>',
                    type: 'POST',
                    datatype: 'json',
                    data: requestData,
                    async: true,
                    success: function( rsp ){
                        rsp = $.parseJSON(rsp);
                        if (rsp.code === 0) {
                            if (mlo_enable == 1) {
                                $("#mloswitch").removeClass("btn-switch-off")
                                .addClass("btn-switch-on")
                                .attr("data-on", "1");
                            }
                            else {
                                $("#mloswitch").removeClass("btn-switch-on")
                                .addClass("btn-switch-off")
                                .attr("data-on", "0");
                            }
                        }
                    }
                });
            }
            $("body").on('click', "#mloswitch", function(e) {
                e && e.preventDefault();
                var bsd = $("#bsdswitch").attr("data-on"),
                    wifi6switch = $('#WIFI6switch').attr("data-on"),
                    mlo = $("#mloswitch").attr("data-on") == "0" ? 1 : 0;
                if (wifi6switch == '1') {
                    return;
                }
                if (bsd == '0') {
                    $.dialog({
                        title: "<%:提示信息%>",
                        content: "<%:检测到未启用Wi-Fi多频合一，无法打开MLO开关。%>",
                        padding: '30px 30px',
                        lock: true,
                        width: 450,
                        ok: function() {}
                    }).lock();
                    return;
                }
                if (mlo == 0) {
                    $.dialog({
                        title: "<%:提示信息%>",
                        content: "<%:关闭MLO多链路加速将会重启Wi-Fi模块，此期间所有接入此路由器的设备都会断开Wi-Fi连接，请确认是否继续。%>",
                        padding: '30px 30px',
                        lock: true,
                        width: 450,
                        ok: function() {
                            setMLOCfg();
                        },
                        cancel: function() {}
                    }).lock();
                }
                else {
                    setMLOCfg();
                }
            })
        });
    }
    if ('<%=split5gSupport%>' == '1') {
        $.sub( 'wifi:mode', function() {
            function setWifiMode() {
                var wifimode = $("#modeSelect").val();
                var requestData = {
                    wifi_split: wifimode
                };
                $.pub( 'wifi:confirm', {
                    ok : function(){
                        $.ajax({
                            url: '<%=luci.dispatcher.build_url("api", "xqsystem", "set_wifi_split")%>',
                            dataType: 'json',
                            timeout: 40000,
                            type: 'POST',
                            data: requestData,
                            success: function( rsp ){
                                if( rsp.code === 0 ){
                                    var time = rsp.hasOwnProperty('time') ? rsp.time : 60
                                    if( time == 0 ){
                                        $.alert('<%:设置成功%>').time(1.5 * 1000);
                                    }else{
                                        var dialog = $.loadingDialog({
                                            title: '<%:修改Wi-Fi设置%>',
                                            content : '<%:设置成功，请等待{$time}秒完成模式切换%>'.tmpl({time}),
                                        }).lock().time( time*1000 );
                                        var interval = setInterval(function(){
                                            if( time < 1 ){
                                                dialog.close()
                                                clearInterval(interval)
                                            }
                                            time --
                                            dialog.content('<%:设置成功，请等待{$time}秒完成模式切换%>'.tmpl({time}))
                                        },1000)
                                    }

                                    setTimeout(function(){
                                        window.location.reload( 1 );
                                    }, (time + 1) * 1000);
                                } else {
                                    $.alert( rsp.msg );
                                }
                            },
                            error: function() {
                                $.alert( '<%:网络异常，请检查是否联网%>' );
                            }
                        });
                    },
                    cancel : function(){},
                    requestData : requestData
                } );
            }
            $(document).on("click", "#btnSetWifiMode", function(e) {
                e.preventDefault();
                setWifiMode();
            });
        });
    }

    $.sub( 'wifi:init', function(evt, data){
        global.wifi = {
            configs: [],
            pddk: {
                '1': '<%=wifi_pddk%>',
                '2': '<%=wifi5_pddk%>',
                '3': '<%=wifi5_2_pddk%>'
            }
        };

        // get wifi and rander html
        var containers = ['wifiset24', 'wifiset50', 'wifiset5g2'],
            tpl = $('#tplWifi').html();

        var wifiinfo = <%=wifiInfo%>;
        var on3 = 1;
        var haswifi50 = $('#wifiset50').length > 0 ? true : false;

        if ( wifiinfo[0].ax == 1 || wifiinfo[0].ax == "1") {
             $('#WIFI6switch')
            .removeClass('btn-switch-on')
            .addClass('btn-switch-off')
            .attr('data-on', '0');
        }
        // 适配双频机型
        if(wificount == 2){
            containers.pop();
            on3 = 0;
        }

        for(var i = 0, len = wifiinfo.length; i < len; i ++){
            var id = containers[i];
            var container;
            //if( !haswifi50 && i == 1 ){
                //container = $(document.getElementById( 'wifisetguest' ));
            //}else{
                if (haswifi50 && i == 1) {
                    if ( wifiinfo[i].txbf == 0 || wifiinfo[i].txbf == "0") {
                         $('#txbfswitch')
                        .removeClass('btn-switch-on')
                        .addClass('btn-switch-off')
                        .attr('data-on', '0');
                    }

                }
                container = $(document.getElementById(id));
            //}
            var wifiitem = wifiinfo[i];
            var password = wifiitem.password;
            var encryption = wifiitem.encryption;
            var type = '<%=active_apcli_index%>';
            var relayWifi = 1;

            var ssidLenMax = 28;
            if (i != 0) {
                ssidLenMax = 31;
            }
            else if (wificount > 2) {
                ssidLenMax = 23;
            }

            if ( encryption == 'none' ) {
                password = '';
            }
            if ( i == type) { 
                relayWifi = 0;
            }
            var tplData = {
                relayWifi: relayWifi,
                wifitype: (!haswifi50 && i == 1) ? i+1 : i,
                wifiIndex: (!haswifi50 && i == 1) ? i+2 : i+1,
                status: wifiitem.status,
                ssid: wifiitem.ssid,
                ssidLenMax: ssidLenMax,
                password: password,
                encryption: wifiitem.encryption,
                channels: $.parseJSON(global.wifi.pddk[i+1]),
                channel: wifiitem.channel,
                bandwidth: wifiitem.bandwidth,
                channelInfo: wifiitem.channelInfo,
                weakenable: wifiitem.weakenable,
                weakthreshold: wifiitem.weakthreshold,
                kickthreshold: wifiitem.kickthreshold,
                hidden: wifiitem.hidden,
                txpwr: wifiitem.txpwr,
                txbf: wifiitem.txbf,
                enabled: wifiitem.enabled,
                wifilei:i,
                on3:on3
            };
            
            container.html( tpl.tmpl(tplData) );
            //debugger;
            global.wifi.configs[i+1] = tplData;
        }

        $('#wifiset24').children('.item').children('.k').text('2.4GHz Wi-Fi')
        $('#wifiset50').children('.item').children('.k').text('5GHz Wi-Fi')
        $('#wifiset5g2').children('.item').children('.k').text('5GHz-Game Wi-Fi')

        if(wifiinfo[0].bsd == 1){
            $('#bsdswitch')
                .removeClass('btn-switch-off')
                .addClass('btn-switch-on')
                .attr('data-on', '1');
            $('.mod-wifi24 .hd h3').text('<%:Wi-Fi%>');
            $('.mod-wifi24 .bd').html( $('#tplbsdWrap').html() );
            $('.mod-wifi50').remove();
            $('.mod-wifi5g-2').hide()
            $(".wifi5gTit").text("5G")

            tpl = $('#tplWifiBsd').html();
            for(var i = 0; i < containers.length; i++){
                $(document.getElementById(containers[i])).html(tpl.tmpl(global.wifi.configs[i+1]))
                $('#wifisetbsdtop').html( $('#tplWifiBsdTop').html().tmpl(global.wifi.configs[1]));
            }
                $('#wifisetbsdtop').html( $('#tplWifiBsdTop').html().tmpl(global.wifi.configs[1]));
                //这得改变下wifitype，与tplwifibsd里的判断相一致，更改这个为1会造成后选择5GGame的信道时出现错误（三频合一时），解决：在渲染时更改它的赋值方式
               // global.wifi.configs[3].wifitype = 1
               // $(document.getElementById('wifiset5g2')).html(tpl.tmpl(global.wifi.configs[3]))
        }
        // 联动TWT
        if ('<%=twtSupport%>' == '1') {
            getTWTCfg();
        }
        // 联动MLO
        if ((wificount > 2) && ('<%=mloSupport%>' == '1')) {
            getMLOCfg();
        }
        $('#wifisetbsd').delegate('input[type=text], input[type=checkbox], input[type=radio]', 'click', onControlFocus)
                        .delegate('.ipt-text,.textContent', 'click', onControlFocus)
        setTimeout( function(){
            $.selectBeautify();
            $.formInit();
            $.pub('wifi:bindEventEncryption');
            $.pub('wifi:bindEventChannel');
            $.pub('wifi:bindEventBandwidth');
        }, 100 );

        $.getJSON('<%=luci.dispatcher.build_url("api","xqnetwork","get_miotrelay_switch")%>')
            .done(function( rsp ){
                if ( rsp.code == 0 ) {
                    if( rsp.enabled == 1 ){
                        $('#cklswitch')
                            .removeClass('btn-switch-off')
                            .addClass('btn-switch-on')
                            .attr('data-on', '1');
                    }else{
                        $('#cklswitch')
                            .removeClass('btn-switch-on')
                            .addClass('btn-switch-off')
                            .attr('data-on', '0');
                    }

                }
            });

    });

    $.sub( 'wifi:bindEventEncryption', function(){
        $( '.encryption' ).on( 'change', function( e ){
            var val = $( this ).val(),
                root = $( this ).parents('form'),
                pwd = root.find('.form-item-pwd'),
                tips = $(this.parentNode).next('.t0');

            var encryption = $(this).parents('form').find('.form-item-encryption');
            if ( val === 'none' ) {
                pwd.hide();
            } else {
                pwd.show();
            }
             if (val === 'psk2') {
                tips.html('<%:仅支持WPA加密方式的设备将无法连接%>').show();
            }else if(val == 'ccmp'||val == 'psk2+ccmp'){
                tips.html('<%:WPA3为新一代加密技术，可使安全性大大加强，但选择该选项后部分旧设备会存在兼容性问题而无法接入%>').show();
            }else if(val == 'none'){
                tips.html('<%:当前加密方法不安全。建议选择混合加密（WPA/WPA2-personal）或其他更安全的加密方法。%>').show();
            }else{
                tips.html('');
            }

            if(val == 'mixed-psk' || val == 'none'){
                encryption.html('<%:非安全加密，建议切换为强加密（WPA2）%>').show();
                encryption.css('margin-bottom','15px')
            }else{
                encryption.html('');
                encryption.css('margin-bottom','0px')
            }
        } );
    });

    $.sub( 'wifi:bindEventChannel', function(){
        $( '.channel' ).on( 'change', function( e ){
            var channelVal = this.value,
                that = this,
                id = $(this).attr('data-id'),
                id = parseInt(id, 10) + 1,
                root = $( this ).parents('form'),
                pwd = root.find('.form-item-pwd'),
                $bandwidth = $( this ).closest('.form').find('[name=bandwidth]'),
                $itemBandwidth = $( this ).closest('.form').find('.itemBandwidth'),
                tips = $(this.parentNode).next('.t'),
                pddk,
                item,
                bandtext,
                bdlist = [];
                var wifiname = $( this ).closest('.form').attr('id');


            if ( channelVal === '0' ) {
                $itemBandwidth.hide();
                return;
            }

            pddk = $.parseJSON( global.wifi.pddk[id] );
            for (var i = 0; i < pddk.length; i++) {
                var _c = pddk[i]['c'];
                if ( _c == channelVal ) {
                    bdlist = pddk[i]['b'];
                    break;
                }
            }
            if (bdlist.length > 3) /*pddk[8]=64 means the country support 36-64*/
            {
                bandtext = '160/80/40/20MHz';
                item = '<option value="0"><%:160/80/40/20MHz%></option>';
            }
     /*       
            else if (bdlist.length == 3)
            {
                bandtext = '80MHz';
                item = '';
            }
    */
            else if(bdlist.length == 3){
                bandtext = '80/40/20MHz';
                item = '<option value="0"><%:80/40/20MHz%></option>';
            }
            else if (bdlist.length == 2)
            {
                bandtext = '40/20MHz';
                item = '<option value="0"><%:40/20MHz%></option>';
            }
            else
            {
                bandtext = '40MHz';
                item = '';
            }

            for ( var i = 0; (i <  bdlist.length) && (i < 3); i++ ) {
                item += '<option value="'+bdlist[i]+'">'+ bdlist[i] +'MHz</option>';
            }

            //$.alert(bdlist.length+''+bandtext);

            if ($bandwidth.val() == '0' && (channelVal <= 161 && channelVal >= 100))
            {
                    // $.alert('<%:160MHz频宽只适用于36至64信道，系统将自动为您切换至80MHz频宽%>');
                    // $bandwidth.html( item ).val("80")
                    // $itemBandwidth
                    //     .find( '.dummy' )
                    //     .text("80MHz");
            }
            else if (($bandwidth.val() == '160'|| $bandwidth.val() == '80'|| $bandwidth.val() == '40' || $bandwidth.val() == '0') && (channelVal == 165))
            {
                    $.alert('<%:当前频宽不支持将要切换的信道，系统已自动选择可用的频宽%>');
                    $bandwidth.html( item ).val("20")
                    $itemBandwidth
                        .find( '.dummy' )
                        .text("20MHz");
            }
            else if (channelVal == 165)
            {
                    $bandwidth.html( item )
                    $itemBandwidth
                        .find( '.dummy' )
                        .text(bandtext);
            }
            else
            {
                    var bandwidthSelect = $bandwidth.val()
                    $bandwidth.html( item ).val(bandwidthSelect);
            }
            /*
            if ( channelVal === '0' ) {
                $itemBandwidth.hide();
                return;
            }
            if(wifiname === 'wifiset24'){
                $bandwidth.html( item ).val( '20' );
                $itemBandwidth
                    .find( '.dummy' )
                    .text("<%:20M%>");
            }else{
                 $bandwidth.html( item );
                 $itemBandwidth
                    .find( '.dummy' )
                    .text("<%:自动%>");
            }
           */        
            $itemBandwidth.show();
      

        });
    } );

    $.sub( 'wifi:bindEventBandwidth', function(){
        $( '.bandwidth' ).on( 'change', function( e ){
            var val = $( this ).val(),
                tips = $(this.parentNode).next('.t0'),
                $channel = $( this ).closest('.form').find('[name=channel]'),
                $itemChannel = $( this ).closest('.form').find('.itemChannel');

                // tips0 = $(this.parentNode).next('.t0');

            if (val === '0') {
                //tips.html('<%:推荐使用自动(80M)频宽，以获得更好的覆盖及抗干扰性能%>').show();
                // if ($channel.val()  >= 100)
                // {
                //     $.alert('<%:160MHz频宽只适用于36至64信道，系统将自动为您切换至36信道%>');
                //     $channel.val('36');
                //     $itemChannel
                //         .find( '.dummy' )
                //         .text("36");q
                // }
            }else{
                tips.html('');
            }

        });
    } );

    $.sub( 'wifi:bindEvent', function( evt, data ){

        function wifiSubmitHandler(e){
            e.preventDefault();
            var formAction = 'set_all_wifi',
                formOjb24 = document.getElementById('wifiset24'),
                formOjb50 = document.getElementById('wifiset50'),
                formOjb5g2 = document.getElementById('wifiset5g2'),
                validator24 = Valid.checkAll(formOjb24),
                validator50 = Valid.checkAll(formOjb50),
                validator5g2 = Valid.checkAll(formOjb5g2);
            if ( validator24 && validator50 && validator5g2) {
                var bsd = 0;
                var form1 = $('#wifiset24');
                var form2 = $('#wifiset50');
                var form3 = $('#wifiset5g2');
                var on1 = $( 'input[name=on]:checked', form1 ).val(),
                    ssid1 = $( 'input[name=ssid]', form1 ).val(),
                    pwd1 =  $( 'input[name=pwd]', form1 ).val(),
                    encryption1 = $( 'select[name=encryption]', form1 ).val(),
                    hidden1 = $('input[name=hidden]', form1 ).prop('checked') ? '1' : '0';
                    channel1 = $( 'select[name=channel]', form1 ).val(),
                    bandwidth1 = $( 'select[name=bandwidth]', form1 ).val(),
                    //txpwr1 = $( 'select[name=txpwr]', form1 ).val(),
                    txpwr1 = $( 'select[name=txpwr]', form1 ).val(),
                    pwd1 = $.pwddecode( pwd1 ),
                    on2 = $( 'input[name=on]:checked', form2 ).val(),
                    ssid2 = $( 'input[name=ssid]', form2 ).val(),
                    pwd2 = $( 'input[name=pwd]', form2 ).val(),
                    encryption2 = $( 'select[name=encryption]', form2 ).val(),
                    hidden2 = $('input[name=hidden]', form2 ).prop('checked') ? '1' : '0';
                    channel2 = $( 'select[name=channel]', form2 ).val(),
                    bandwidth2 = $( 'select[name=bandwidth]', form2 ).val(),
                    //txpwr2 = $( 'select[name=txpwr]', form2 ).val();
                    txpwr2 = $( 'select[name=txpwr]', form2 ).val(),
                    on3 = $( 'input[name=on]:checked', form1 ).val(),
                    ssid3 = $( 'input[name=ssid]', form3 ).val(),
                    pwd3 = $( 'input[name=pwd]', form3 ).val(),
                    encryption3 = $( 'select[name=encryption]', form3 ).val(),
                    hidden3 = $('input[name=hidden]', form3 ).prop('checked') ? '1' : '0';
                    channel3 = $( 'select[name=channel]', form3 ).val(),
                    bandwidth3 = $( 'select[name=bandwidth]', form3 ).val(),
                    txpwr3 = $( 'select[name=txpwr]', form3 ).val(),
                    hardware = '<%=hardware%>';

                var isDFS;

                if ((channel2 >= 52 && channel2 <= 144) || (bandwidth2 == 0))
                {
                    isDFS = 1;
                }
                else
                {
                    isDFS = 0;
                }
                //当5G频段关闭时，也不需要有雷达检测的提示
                if (on2 == 0){
                    isDFS = 0
                }
                var requestData = {
                    bsd: bsd,
                    on1: on1,
                    ssid1: ssid1,
                    encryption1: encryption1,
                    channel1: channel1,
                    bandwidth1: bandwidth1,
                    hidden1: hidden1,
                    txpwr1: txpwr1,
                    pwd1: pwd1,
                    on2: on2,
                    ssid2: ssid2,
                    encryption2: encryption2,
                    channel2: channel2,
                    bandwidth2: bandwidth2,
                    hidden2: hidden2,
                    txpwr2: txpwr2,
                    pwd2: pwd2,
                    on3: on3,
                    ssid3: ssid3,
                    encryption3: encryption3,
                    channel3: channel3,
                    bandwidth3: bandwidth3,
                    hidden3: hidden3,
                    txpwr3: txpwr3,
                    pwd3: pwd3,
                    isDFS: isDFS,
                };

                $.pub( 'wifi:confirm', {
                    ok : function(){
                        $.pub('loading:start');
                        $.ajax({
                            url: '<%=luci.dispatcher.build_url("api", "xqnetwork", "set_all_wifi")%>',
                            dataType: 'json',
                            timeout: 40000,
                            type: 'POST',
                            data: requestData,
                            success: function( rsp ){
                                //$.pub('loading:stop');
                                if( rsp.code === 0 ){
                                    $.pub( 'wifi:success' , {
                                        cac_time : rsp.cac_time,
                                    });
                                } else {
                                    if ( rsp.code !== 401) {
                                        var msg = StringH.encode4Html( rsp.msg );
                                        $.alert( msg ).lock();
                                    }
                                }
                            },
                            error: function() {
                                $.pub('loading:stop');
                                $.alert( '<%:网络异常，请检查是否联网%>' );
                            }
                        });
                    },
                    cancel : function(){}
                } );
            }
        }

        function bsdWiFiSubmitHandler(e){
            e && e.preventDefault();
            var formObj = document.getElementById('wifisetbsd'),
                validator = Valid.checkAll(formObj);
            if(!validator){
                return;
            }
            var bsd = $('#bsdswitch').attr('data-on') == 1 ? 1 : 0;
            var topContainer = $('#wifisetbsdtop');
            var form1 = $('#wifiset24');
            var form2 = $('#wifiset50');
            var form3 = $('#wifiset5g2');
            var on1 = 1,
                ssid1 = $( 'input[name=ssid]', topContainer ).val(),
                pwd1 =  $( 'input[name=pwd]', topContainer ).val(),
                encryption1 = $( 'select[name=encryption]', topContainer ).val(),
                hidden1 = $('input[name=hidden]', topContainer ).prop('checked') ? '1' : '0';
                channel1 = $( 'select[name=channel]', form1 ).val(),
                bandwidth1 = $( 'select[name=bandwidth]', form1 ).val(),
                txpwr1 = $( 'select[name=txpwr]', form1 ).val(),
                pwd1 = $.pwddecode( pwd1 ),
                on2 = on1,
                ssid2 = ssid1,
                pwd2 = pwd1,
                encryption2 = encryption1,
                hidden2 = hidden1,
                channel2 = $( 'select[name=channel]', form2 ).val(),
                bandwidth2 = $( 'select[name=bandwidth]', form2 ).val(),
                txpwr2 = $( 'select[name=txpwr]', form2 ).val(),
                on3 = on1,
                ssid3 = ssid1,
                pwd3 = pwd1,
                encryption3 = encryption1,
                hidden3 = hidden1;
                channel3 = $( 'select[name=channel]', form3 ).val(),
                bandwidth3 = $( 'select[name=bandwidth]', form3 ).val(),
                txpwr3 = $( 'select[name=txpwr]', form3 ).val(),
                hardware = '<%=hardware%>';
                var isDFS;

                if ((channel2 >= 52 && channel2 <= 144) || (bandwidth2 == 0))
                {
                    isDFS = 1;
                }
                else
                {
                    isDFS = 0;
                }
                //当5G频段关闭时，也不需要有雷达检测的提示
                if (on2 == 0){
                    isDFS = 0
                }

            var requestData = {
                bsd: bsd,
                on1: on1,
                ssid1: ssid1,
                encryption1: encryption1,
                channel1: channel1,
                bandwidth1: bandwidth1,
                hidden1: hidden1,
                txpwr1: txpwr1,
                pwd1: pwd1,
                on2: on2,
                ssid2: ssid2,
                encryption2: encryption2,
                channel2: channel2,
                bandwidth2: bandwidth2,
                hidden2: hidden2,
                txpwr2: txpwr2,
                pwd2: pwd2,
                on3: on3,
                ssid3: ssid3,
                encryption3: encryption3,
                channel3: channel3,
                bandwidth3: bandwidth3,
                hidden3: hidden3,
                txpwr3: txpwr3,
                pwd3: pwd3,
                isDFS: isDFS,
            };
            $.pub('loading:start');
            $.ajax({
                url: '<%=luci.dispatcher.build_url("api", "xqnetwork", "set_all_wifi")%>',
                dataType: 'json',
                timeout: 40000,
                type: 'POST',
                data: requestData,
                success: function( rsp ){
                    //$.pub('loading:stop');
                    if( rsp.code === 0 ){
                        $.pub( 'wifi:success' , {
                            cac_time : rsp.cac_time,
                        });
                    } else {
                        if ( rsp.code !== 401) {
                            var msg = StringH.encode4Html( rsp.msg );
                            $.alert( msg ).lock();
                        }
                        $.pub('loading:stop');
                    }
                },
                error: function() {
                    $.pub('loading:stop');
                    $.alert( '<%:网络异常，请检查是否联网%>' );
                }
            });
        }

        $('#wifiset24').on('submit', wifiSubmitHandler);
        $('#wifiset50').on('submit', wifiSubmitHandler);
        $('#wifiset5g2').on('submit', wifiSubmitHandler);
        $('body').delegate('#wifisetbsd', 'submit', bsdWiFiSubmitHandler);

        $('body').delegate('input[name=ssid]' ,'blur', function(e){
            var tar = e.currentTarget;
            if ( escape(tar.value).indexOf("%u") >= 0 ) {
                $(tar.parentNode).next('.t').text('<%:此SSID会导致某些设备支持不佳%>').show();
            }
        });

        $('#wifiset24, #wifiset50,#wifiset5g2').delegate('input[type=text], input[type=checkbox], input[type=radio]', 'click', onControlFocus)
                .delegate('.ipt-text', 'click', onControlFocus);

                $('#wifiset24, #wifiset50,#wifiset5g2, #roamset24,#roamset50').delegate('input[type=text],input[type=password]','focus', onControlFocus)
        $('#WIFI6switch').on('click', function(e){
            e.preventDefault();
            var ax = $(this).attr('data-on');
            var self = this;

            var isDFS;

            if ((global.wifi.configs[2].channel >= 52 && global.wifi.configs[2].channel <= 64)
                || ( global.wifi.configs[2].bandwidth == 0))
            {
                isDFS = 1;
            }
            else
            {
                isDFS = 0;
            }

            var requestData = {
                ax: ax,
                isDFS: isDFS,
            };
            $.pub('loading:start')
            $.ajax({
                url: '<%=luci.dispatcher.build_url("api", "xqnetwork", "set_wifi_ax")%>',
                dataType: 'json',
                timeout: 40000,
                type: 'POST',
                data: requestData,
                success: function( rsp ){
                    if( rsp.code === 0 ){
                        if(ax == 1) {
                            $(self)
                            .removeClass('btn-switch-on')
                            .addClass('btn-switch-off')
                            .attr('data-on', '0');
                        }else {
                            $(self)
                            .removeClass('btn-switch-off')
                            .addClass('btn-switch-on')
                            .attr('data-on', '1');
                            }

                        $.pub( 'wifi:success', {
                            cac_time : rsp.cac_time,
                        });
                    } else {
                        $.pub('loading:stop')
                        if ( rsp.code !== 401) {
                            var msg = StringH.encode4Html( rsp.msg );
                            $.alert( msg ).lock();
                        }
                    }
                },
                error: function() {
                    $.pub('loading:stop');
                    $.alert( '<%:网络异常，请检查是否联网%>' );
                }
            });

        });

        $('#txbfswitch').on('click', function(e){
            e.preventDefault();
            var txbf = $(this).attr('data-on') == 1 ? 0 : 3;
            var self = this;

            if ((global.wifi.configs[2].channel >= 52 && global.wifi.configs[2].channel <= 144)
                || ( global.wifi.configs[2].bandwidth == 0))
            {
                isDFS = 1;
            }
            else
            {
                isDFS = 0;
            }

            var requestData = {
                txbf: txbf,
                isDFS: isDFS,
            };
            $.pub('loading:start')
            $.ajax({
                url: '<%=luci.dispatcher.build_url("api", "xqnetwork", "set_wifi_txbf")%>',
                dataType: 'json',
                timeout: 40000,
                type: 'POST',
                data: requestData,
                success: function( rsp ){
                    if( rsp.code === 0 ){
                        if(txbf == 0) {
                            $(self)
                            .removeClass('btn-switch-on')
                            .addClass('btn-switch-off')
                            .attr('data-on', '0');
                        }else {
                            $(self)
                            .removeClass('btn-switch-off')
                            .addClass('btn-switch-on')
                            .attr('data-on', '1');
                            }

                        $.pub( 'wifi:success', {
                            cac_time : rsp.cac_time,
                        });
                    } else {
                        $.pub('loading:stop')
                        if ( rsp.code !== 401) {
                            var msg = StringH.encode4Html( rsp.msg );
                            $.alert( msg ).lock();
                        }
                    }
                },
                error: function() {
                    $.pub('loading:stop');
                    $.alert( '<%:网络异常，请检查是否联网%>' );
                }
            });

        });


        $('#cklswitch').on('click', function(e){
            e.preventDefault();
            var cklOn = $(this).attr('data-on') == 1 ? 0 : 1
            var self = this;

            var requestData = {
                on: cklOn
            };
            $.ajax({
                url: '<%=luci.dispatcher.build_url("api", "xqnetwork", "miotrelay_switch")%>',
                dataType: 'json',
                timeout: 40000,
                type: 'POST',
                data: requestData,
                success: function( rsp ){
                    if( rsp.code === 0 ){
                        if(cklOn == 1) {
                            $(self)
                                .removeClass('btn-switch-off')
                                .addClass('btn-switch-on')
                                .attr('data-on', '1');
                        }else {
                            $(self)
                                .removeClass('btn-switch-on')
                                .addClass('btn-switch-off')
                                .attr('data-on', '0');
                        }
                    } else {
                        // if ( rsp.code !== 401) {
                        //     var msg = StringH.encode4Html( rsp.msg );
                        //     $.alert( msg ).lock();
                        // }
                    }
                },
                error: function() {
                    $.alert( '<%:网络异常，请检查是否联网%>' );
                }
            });

        });
          
        $('#bsdswitch').on('click', function(e){
            e.preventDefault();
            var on = $(this).attr('data-on');
            var self = this;
            if ((global.wifi.configs[2].channel >= 52 && global.wifi.configs[2].channel <= 144)
                || ( global.wifi.configs[2].bandwidth == 0))
            {
                isDFS = 1;
            }
            else
            {
                isDFS = 0;
            }
            //当5G频段关闭时，也不需要有雷达检测的提示
            if (global.wifi.configs[2].status == 0){
                isDFS = 0
            }

            if( on == 0 ){
                var formObj = document.getElementById('wifiset24'),
                    validator = Valid.checkAll(formObj);
                if(!validator){
                    return;
                }
                var formOjb = $('#wifiset24');
                // var on1 = $( 'input[name=on]:checked', formOjb ).val(),
                var on1 = 1,
                    ssid1 = $( 'input[name=ssid]', formOjb ).val(),
                    pwd1 =  $( 'input[name=pwd]', formOjb ).val(),
                    encryption1 = $( 'select[name=encryption]', formOjb ).val(),
                    channel1 = $( 'select[name=channel]', formOjb ).val(),
                    bandwidth1 = $( 'select[name=bandwidth]', formOjb ).val(),
                    hidden1 = $('input[name=hidden]', formOjb ).prop('checked') ? '1' : '0',
                    txpwr1 = $( 'select[name=txpwr]', formOjb ).val(),
                    pwd1 = $.pwddecode( pwd1 );
                var requestData = {
                    bsd: 1,
                    on1: on1,
                    ssid1: ssid1,
                    encryption1: encryption1,
                    channel1: channel1,
                    bandwidth1: bandwidth1,
                    hidden1: hidden1,
                    txpwr1: txpwr1,
                    pwd1: pwd1,
                    isDFS: isDFS,
                };
                $.pub('loading:start');
                $.ajax({
                    url: '<%=luci.dispatcher.build_url("api", "xqnetwork", "set_all_wifi")%>',
                    dataType: 'json',
                    timeout: 40000,
                    type: 'POST',
                    data: requestData,
                    success: function( rsp ){
                        
                        if( rsp.code === 0 ){
                            $(self)
                            .removeClass('btn-switch-off')
                            .addClass('btn-switch-on')
                            .attr('data-on', '1');
                            if ((wificount > 2) && ('<%=mloSupport%>' == '1')) {
                                getMLOCfg();
                            }
                            $.pub( 'wifi:success', {
                                cac_time : rsp.cac_time
                            });
                        } else {
                            $.pub('loading:stop')
                            if ( rsp.code !== 401) {
                                var msg = StringH.encode4Html( rsp.msg );
                                $.alert( msg ).lock();
                            }
                        }
                    },
                    error: function() {
                        $.pub('loading:stop');
                        $.alert( '<%:网络异常，请检查是否联网%>' );
                    }
                });
            }else{
                var tips = '<%:WiFi双频合一关闭，5G会默认使用2.4G相同的网络名称（加后缀_5G）和密码，如需设成不一样，请进行修改。%>';
                if ('<%=wifi_count%>' == 3) {
                    if ('<%=wifi_game%>' == 1) {
                        tips = '<%:WiFi多频合一关闭，5GHz和5GHz-Game Wi-Fi会默认使用2.4GHz相同的网络名称（加后缀）和密码，如需设成不一样，请进行修改。%>';
                    }
                    else {
                        tips = '<%:WiFi多频合一关闭，5GHz和5GHz-2 Wi-Fi会默认使用2.4GHz相同的网络名称（加后缀）和密码，如需设成不一样，请进行修改。%>';
                    }
                }
                $.dialog({
                    width: 390,
                    title : "<%:提示信息%>",
                    content : tips,
                    ok: function(){
                        var formObj = document.getElementById('wifisetbsd'),
                            validator = Valid.checkAll(formObj);
                        if(!validator){
                            return;
                        }
                        $(self)
                        .removeClass('btn-switch-on')
                        .addClass('btn-switch-off')
                        .attr('data-on', '0');
                        setTimeout(function(){
                            bsdWiFiSubmitHandler();
                        }, 0);
                    }
                });
            }
        });
    });

    $.sub( 'wifi:success', function( evt, data ){
        var cac_time =  data.cac_time;
        if (cac_time && cac_time !=0)
        {
            $.pub('loading:stop')
            $.radarDialog({
              width:500,
            title : '<%:修改 Wi-Fi 设置%>',
            content : '<div class="dialog_con_radar"></div><div class="radar_tips">'+'<%:遵照国家法律法规，路由器正在做退避雷达信号探测，Wi-Fi信号要{$time}秒后才能开启，请稍候%>'.tmpl({time: '<span>'+cac_time+'</span>'})+'</div>',
            cancel: false
            }).lock().time( cac_time*1000 );
            setTimeout( function(){
                window.location.reload(true);
            }, cac_time*1000 );
            setInterval(function(){
              var n = $('.radar_tips').find('span').html();
              $('.radar_tips').find('span').html(--n);
            },1000)
        }
        else
        {
            setTimeout( function(){
                $.pub('loading:stop')
                $.pub( 'wifi:wifiSetSucessDialog');
            },1000)
            
            
        }
    } );

    $.sub( 'wifi:confirm', function( evt, data ){
        var ok = data.ok || function(){},
            cancel = data.cancel || function(){};
        var content = '<%:该操作将重启 Wi-Fi 并导致 Wi-Fi 下的所有设备失去连接，是否确认修改？%>';
        if (data.requestData && data.requestData.wifi_split == 0) {
            content = "<%:该修改会导致路由器重启，所有设备会短暂失去连接，是否确认修改？%>"
        }
        else if (data.requestData && data.requestData.wifi_split == 1) {
            content = "<%:三频模式覆盖明显弱于双频模式，该修改会导致路由器重启，所有设备会短暂失去连接，是否确认修改？%>"
        }
        $.dialog({
            id : "confirm",
            width: 390,
            title : "<%:修改Wi-Fi设置%>",
            content : content,
            ok: function(){
                ok();
            },
            cancel: function () {
                cancel();
            }
        }).lock();
    } );

    $.sub( 'wifi:modify', function( evt, data ){
        var requestData =  data.requestData;
        var url = data.url;
        $.ajax({
            url: url,
            dataType: 'json',
            timeout: 40000,
            type: "POST",
            data: requestData,
            success: function( rsp ) {
                if( rsp.code === 0 ){
                    $.pub( 'wifi:success', {
                            requestData : requestData,
                        });
                } else {
                    if ( rsp.code !== 401) {
                        var msg = StringH.encode4Html( rsp.msg );
                        $.alert( msg ).lock();
                    }
                }
            },
            error: function() {
                $.alert( '<%:网络异常，请检查是否联网%>' );
            }
        });
    });

    if ('<%=twtSupport%>' == '1') {
        function getTWTCfg() {
            if ($("#WIFI6switch").attr("data-on") == 1) {
                $("#twtswitch").removeClass("btn-switch-on")
                .addClass("btn-switch-off")
                .attr("data-on", "0");
                $(".mod-twt").find(".tips").show();
                return;
            }
            $.ajax({
                url: '<%=luci.dispatcher.build_url("api", "xqnetwork", "get_twt")%>',
                type: 'GET',
                datatype: 'json',
                async: true,
                success: function( rsp ){
                    rsp = $.parseJSON(rsp);
                    if (rsp.code === 0) {
                        if (rsp.status == 1) {
                            $("#twtswitch").removeClass("btn-switch-off")
                            .addClass("btn-switch-on")
                            .attr("data-on", "1");
                        }
                        else {
                            $("#twtswitch").removeClass("btn-switch-on")
                            .addClass("btn-switch-off")
                            .attr("data-on", "0");
                        }
                    }
                }
            });
        }
        $.sub( 'wifi:twt' , function(){
            function setTWTCfg() {
                var on = $("#twtswitch").attr("data-on") == "0" ? 1 : 0,
                    requestData = {on};

                $.ajax({
                    url: '<%=luci.dispatcher.build_url("api", "xqnetwork", "set_twt")%>',
                    type: 'POST',
                    datatype: 'json',
                    data: requestData,
                    async: true,
                    success: function( rsp ){
                        rsp = $.parseJSON(rsp);
                        if (rsp.code === 0) {
                            if (on == 1) {
                                $("#twtswitch").removeClass("btn-switch-off")
                                .addClass("btn-switch-on")
                                .attr("data-on", "1");
                            }
                            else {
                                $("#twtswitch").removeClass("btn-switch-on")
                                .addClass("btn-switch-off")
                                .attr("data-on", "0");
                            }
                        }
                    }
                });
            }

            $('body').on('click', '#twtswitch', function(e) {
                e && e.preventDefault();
                var wifi6switch = $('#WIFI6switch').attr("data-on");
                if (wifi6switch == '1') {
                    return;
                }
                setTWTCfg();
            })

            $('.help .ico').on('click', function(){
                $('#helpArrow').show();
                $('#helpSection').show();
            });
            $('.help-close').on('click', function(){
                $('#helpArrow').hide();
                $('#helpSection').hide();
            });
        });
    }
    // 切换信道带宽联动逻辑
    $('body').on("change", "select[name=channel]", function() {
        var formObj = $(this).closest(".form");
        var bwObj = formObj.find("select[name=bandwidth]");
        var bwItem = formObj.find('.itemBandwidth');
        var bwVal = bwObj.val();
        var chVal = formObj.find("select[name=channel]").val();
        var isSupport160M = bwObj.text().indexOf("160") > -1;

        // 当自动带宽支持160时才切换
        if ((isSupport160M && (bwVal == 0 || bwVal == 160)) && (chVal >= 149 && chVal <= 161)) {
            bwObj.val(80);
            bwItem.find('.dummy').text("80MHz");
            $.alert("<%:当前频宽不支持将要切换的信道，系统已自动选择可用的频宽%>");
        }
        else if ((bwVal == 160 || bwVal == 80 || bwVal == 40 || bwVal == 0) && chVal == 165) {
            bwObj.val(20);
            bwItem.find('.dummy').text("20MHz");
            $.alert("<%:当前频宽不支持将要切换的信道，系统已自动选择可用的频宽%>");
        }
    });

    $('body').on("change", "select[name=bandwidth]", function() {
        var formObj = $(this).closest(".form");
        var chObj = formObj.find("select[name=channel]");
        var bwObj = formObj.find("select[name=bandwidth]");
        var chItem = formObj.find('.itemChannel');
        var chVal = chObj.val();
        var bwVal = formObj.find("select[name=bandwidth]").val();
        var isSupport160M = bwObj.text().indexOf("160") > -1;

        // 当自动带宽支持160时才切换
        if ((isSupport160M && (bwVal == 0 || bwVal == 160)) && (chVal >= 149 && chVal <= 161)) {
            chObj.val(0);
            var autoText = chObj.find("option:contains('自动')").text();
            chItem.find('.dummy').text(autoText);
            $.alert("<%:当前频宽不支持将要切换的信道，系统已自动选择可用的频宽%>");
        }
        else if ((bwVal == 160 || bwVal == 80 || bwVal == 40 || bwVal == 0) && chVal == 165) {
            chObj.val(0);
            var autoText = chObj.find("option:contains('自动')").text();
            chItem.find('.dummy').text(autoText);
            $.alert("<%:当前频宽不支持将要切换的信道，系统已自动选择可用的频宽%>");
        }
    });

    $(function(){
        if ('<%=split5gSupport%>' == '1') {
            $.pub( 'wifi:mode' );
        }
        $.pub( 'wifi:init' );
        if ((wificount > 2) && ('<%=mloSupport%>' == '1')) {
            $.pub( 'wifi:mlo' );
        }
        if ('<%=twtSupport%>' == '1') {
            $.pub( 'wifi:twt');
        }
        $.pub( 'wifi:bindEvent' );
    });
}());
</script>
